#! /bin/sh -e

# Generate one fat Swift file in order to include it when calling Sourcery

SCRIPTPATH=$(dirname "$0")
TEMPLATES=${TEMPLATES:-"$SCRIPTPATH/../Templates"}
SRCPATH=${SRCPATH:-"$SCRIPTPATH/../Sources"}

modified_files=$(find "$SRCPATH" -type f -newer "$TEMPLATES/AnnotationInject.swift" 2> /dev/null | wc -l)

if [ -f "$TEMPLATES/AnnotationInject.swift" ] && [ $modified_files -eq 0 ];then
    echo "Using existing AnnotationInject.swift file..."
    exit 0
fi

echo "Generating new AnnotationInject.swift file..."

cat <<EOF > "$TEMPLATES/AnnotationInject.swift"
// Generated by AnnotationInject on `date`
<%
`find "$SRCPATH" -name "*.swift" | xargs -I F sh -c 'cat F; echo'`
-%>
EOF
